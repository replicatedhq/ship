apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  labels:
    app: elasticsearch
    chart: elasticsearch-1.15.1
    component: data
    heritage: Tiller
    release: elastic-stack
  name: elastic-stack-elasticsearch-data
spec:
  template:
    spec:
      $setElementOrder/containers:
      - name: elasticsearch
      $setElementOrder/initContainers:
      - name: sysctl
      - name: chown
      containers:
      - $setElementOrder/env:
        - name: SERVICE
        - name: KUBERNETES_MASTER
        - name: KUBERNETES_NAMESPACE
        - name: NODE_MASTER
        - name: PROCESSORS
        - name: ES_JAVA_OPTS
        - name: MINIMUM_MASTER_NODES
        $setElementOrder/volumeMounts:
        - mountPath: /usr/share/elasticsearch/data
        - mountPath: /usr/share/elasticsearch/config/elasticsearch.yml
        - mountPath: /usr/share/elasticsearch/config/log4j2.properties
        - mountPath: /pre-stop-hook.sh
        env:
        - name: SERVICE
          value: elastic-stack-elasticsearch-master
        - name: KUBERNETES_MASTER
          value: kubernetes.default.svc.cluster.local
        - name: KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: ES_JAVA_OPTS
          value: -Djava.net.preferIPv4Stack=true -Xms1536m -Xmx1536m
        - $patch: delete
          name: DISCOVERY_SERVICE
        image: gcr.io/cos-containers/elasticsearch:5.4.2-xpack
        imagePullPolicy: Always
        lifecycle:
          postStart: null
        name: elasticsearch
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - curl --request GET --silent --output /dev/null http://127.0.0.1:9200/_cluster/health?local=true
          httpGet: null
        volumeMounts:
        - mountPath: /usr/share/elasticsearch/config/elasticsearch.yml
          readOnly: true
        - mountPath: /usr/share/elasticsearch/config/log4j2.properties
          name: config
          readOnly: true
          subPath: log4j2.properties
        - $patch: delete
          mountPath: /post-start-hook.sh
      initContainers:
      - image: busybox
        name: sysctl
      - image: gcr.io/cos-containers/elasticsearch:5.4.2-xpack
        imagePullPolicy: Always
        name: chown
      securityContext: null
      serviceAccountName: elastic-stack-elasticsearch
  updateStrategy: null
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 4Gi
