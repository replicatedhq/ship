---
####
assets:
  v1:
  - inline:
      contents: |
        #!/bin/sh
        set -e

        echo "piping images"
        ./assets/pipe_images.sh

        echo "ensuring namespace"
        kubectl get ns {{ship config "namespace"}} \
        || \
        kubectl create ns {{ship config "namespace" }}

        echo "deploying resources"
        kubectl apply -n {{ship config "namespace" }} -f ./assets/k8s/

      dest: ./assets/install.sh
      mode: 0777
  - inline:
      contents: |
        #!/bin/sh
        set -e
        kubectl delete -n {{ship config "namespace" }} -f ./assets/k8s/

      dest: ./assets/uninstall.sh
      mode: 0777
  - inline:
      contents: |
        #!/bin/sh
        set -e

        echo
        echo Pushing docker images to {{ship config "docker_registry" }}.
        echo You will need to ensure you are logged into this registry with write access.
        echo

        for component in db api processor; do
          docker load < ./docker/${component}.tar
          docker tag \
            registry.staging.replicated.com/shipretraced/retraced-${component}:1.1.12-slim-20180329 \
            {{ship config "docker_registry"}}/retraced-${component}:1.1.12-slim-20180329
          docker push {{ship config "docker_registry"}}/retraced-${component}:1.1.12-slim-20180329
        done
      dest: ./assets/pipe_images.sh
      mode: 0777
  - inline:
      contents: |
        apiVersion: v1
        kind: Pod
        metadata:
          name: retraced-pg-migrate
          labels:
            app: retraced-pg-migrate
        spec:{{ship if (ne (config "image_pull_secret") "") }}
          imagePullSecrets:
            - name: {{ship config "image_pull_secret"}}{{ship end}}
          containers:
            - name: db
              image: {{ship config "docker_registry"}}/retraced-db:1.1.12-slim-20180329
              command:
                - bin/retraceddb
                - up
                - pg
              env:
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_USER
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_PASSWORD
                - name: POSTGRES_HOST
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_HOST
                - name: POSTGRES_PORT
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_PORT
                - name: POSTGRES_DATABASE
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_DATABASE
      dest: ./assets/k8s/postgres.yml
      mode: 0666
  - docker:
      image: registry.staging.replicated.com/shipretraced/retraced-db:1.1.12-slim-20180329
      dest: docker/db.tar
      source: replicated
      private: true
  - docker:
      image: registry.staging.replicated.com/shipretraced/retraced-api:1.1.12-slim-20180329
      dest: docker/api.tar
      source: replicated
      private: true
  - docker:
      image: registry.staging.replicated.com/shipretraced/retraced-processor:1.1.12-slim-20180329
      dest: docker/processor.tar
      source: replicated
      private: true

config:
  v1:
    - name: cluster_info
      title: Kubernetes Cluster Info
      description: information about your kubernetes cluster
      items:
      - name: namespace
        title: Namespace to Deploy into
        type: text
        required: true
        default: default
      - name: api_replicas
        title: Number of api servers to deploy
        type: text
        required: true
        default: 2
      - name: worker_replicas
        title: Number of Workers to deploy
        type: text
        required: true
        default: 2
      - name: docker_registry
        title: |
          Base URL of a private docker registry.
          You will need to provision following repositories provisioned:
           - `retraced-db`
           - `retraced-api`
           - `retraced-processor`
        required: true
        type: text
      - name: image_pull_secret
        title: '[Optional] Name of an image pull secret to use when pulling from your private docker registry'
        required: false
        type: text

lifecycle:
  v1:
  - render:
      skip_state_warning: true
  - message:
     level: info
     contents: |
       Assets for retraced have been generated. If you have docker and kubectl set up locally,
       you can run the following from this directory to install retraced to your cluster.

          bash ./assets/install.sh

  - message:
     level: warn
     contents: |
       A state file has been written to {{ship context "state_file_path" }} -- please store it
       somewhere safe, you'll need it if you want to update or recover this installation of SuperBigTool.
